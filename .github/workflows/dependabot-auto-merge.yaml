name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  dependabot-auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    permissions:
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Checkout the PR branch to allow pushing commits
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum

      - name: Check SDK generation
        run: |
          git status --porcelain > /tmp/before_gen_sdk.txt

          make gen-sdk

          # Check git status
          git status --porcelain > /tmp/after_gen_sdk.txt

          # Compare the two status files
          if ! diff -q /tmp/before_gen_sdk.txt /tmp/after_gen_sdk.txt > /dev/null; then
            # Get list of changed file paths
            CHANGED_FILES=$(git status --porcelain | awk '{print $2}')

            # Check if all changed files are under sdk/ path
            UNAUTHORIZED_CHANGES=0
            if [ -n "$CHANGED_FILES" ]; then
              while IFS= read -r file; do
                if [ -n "$file" ]; then
                  # Check if file starts with sdk/
                  if [[ ! "$file" =~ ^sdk/ ]]; then
                    UNAUTHORIZED_CHANGES=1
                    break
                  fi
                fi
              done <<< "$CHANGED_FILES"
            fi

            if [ "$UNAUTHORIZED_CHANGES" -eq 1 ]; then
              echo "‚ùå SDK is not up to date in the repo. Make sure to run 'make gen-sdk && make gen-sdk-dockerized' and commit."
              echo "Files changed:"
              git status --porcelain
              echo ""
              exit 1
            else
              echo "‚úÖ Only files under sdk/ changed. Will commit and push to PR branch."
            fi
          else
            echo "‚úÖ SDK is up to date."
          fi

      - name: Commit and push SDK changes
        id: commit_changes
        run: |
          # Check if there are any changes
          if [ -n "$(git status --porcelain)" ]; then
            # Configure git user for commits
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # Set up remote URL with token for pushing
            git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

            # Add all files under sdk/ path
            git add sdk/

            # Check if there are staged changes
            if [ -n "$(git diff --cached --name-only)" ]; then
              PR_BRANCH="${{ github.event.pull_request.head.ref }}"

              # Don't use [skip ci] so workflows run on the new commit
              git commit -m "chore: update SDK files"

              # Get the commit SHA before pushing (this is the commit we're about to push)
              NEW_SHA=$(git rev-parse HEAD)
              echo "üìù Created commit $NEW_SHA"

              # Push the commit
              git push origin HEAD:$PR_BRANCH

              # Fetch to ensure we have the latest remote state
              git fetch origin $PR_BRANCH

              # Verify the commit exists on the remote and get the remote commit SHA
              REMOTE_SHA=$(git rev-parse origin/$PR_BRANCH)

              if [ "$NEW_SHA" != "$REMOTE_SHA" ]; then
                echo "‚ö†Ô∏è Warning: Local commit SHA ($NEW_SHA) differs from remote SHA ($REMOTE_SHA)"
                echo "Using remote SHA for tagging: $REMOTE_SHA"
                NEW_SHA="$REMOTE_SHA"
              else
                echo "‚úÖ Verified commit $NEW_SHA exists on remote branch $PR_BRANCH"
              fi

              echo "‚úÖ Committed and pushed SDK changes to PR branch: $PR_BRANCH"
              echo "committed=true" >> $GITHUB_OUTPUT
              echo "new_sha=$NEW_SHA" >> $GITHUB_OUTPUT
            else
              echo "‚ÑπÔ∏è No changes to commit for SDK files."
              echo "committed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ÑπÔ∏è No changes detected."
            echo "committed=false" >> $GITHUB_OUTPUT
          fi

      - name: Enable auto-merge for Dependabot PRs
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # If we just pushed a commit, wait a moment for GitHub to recognize it
          if [ "${{ steps.commit_changes.outputs.committed }}" == "true" ]; then
            echo "‚è≥ Commit was pushed, waiting for GitHub to recognize the new commit..."
            sleep 5

            # Verify the latest commit is recognized by fetching PR info
            LATEST_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid -q .headRefOid)
            echo "üìù Latest commit on PR: $LATEST_SHA"
          fi

          # Enable auto-merge - GitHub will merge when all checks pass on the latest commit
          # The auto-merge system monitors the PR and will wait for checks on any new commits
          gh pr merge "$PR_NUMBER" --auto --squash

          echo "‚úÖ Auto-merge enabled for PR #$PR_NUMBER. PR will merge automatically when all checks pass."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
